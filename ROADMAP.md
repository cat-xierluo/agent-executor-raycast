# Agent Executor 项目路线图

> Last updated: 2026-01-11
> 本文是 Agent Executor Raycast Extension 的发展路线图，记录已完成功能和未来计划。

## 项目愿景

打造一个高效、智能的通用 Raycast 扩展，让用户能够通过简洁的界面快速调用任何 Claude Code 项目的 AI 命令和技能，实现文件的智能处理和自动化操作。

## 当前进展概览

- **✅ 核心功能完成**: 命令列表、文件选择、命令执行已实现
- **✅ 多项目支持**: 支持最多 5 个项目目录，命令显示来源项目
- **✅ 工作目录修复**: 命令在其所属项目目录中执行，正确处理依赖
- **✅ 配置系统完善**: Raycast 配置页面，支持自定义项目目录和 Claude CLI 路径
- **✅ DevonThink 集成**: 支持 DevonThink 2/3 文件选择和导出
- **✅ 统计功能上线**: 命令执行统计已集成到运行状态界面
- **✅ 通用化重命名**: 扩展重命名为 "Agent Executor"，适用于任何 Claude Code 项目
- **✅ 关键问题修复**: 完成任务状态读取和监控系统的所有关键缺陷修复
- **🔄 持续优化中**: 用户体验和稳定性持续改进

## 阶段状态速览

| 阶段                              | 目标摘要                           | 当前进度   | 状态        |
| :-------------------------------- | :--------------------------------- | :--------- | :---------- |
| **阶段一：MVP 核心**        | 基础命令执行、文件选择、多项目支持 | 6/6 完成   | 🟢 已完成   |
| **阶段二：DevonThink 集成** | 支持 DevonThink 文件操作           | 4/4 完成   | 🟢 已完成   |
| **阶段三：日志与监控**      | 基础日志系统和状态监控             | 10/10 完成 | 🟢 已完成   |
| **阶段四：关键修复**        | 修复任务状态读取和监控系统         | 8/8 完成   | 🟢 已完成   |
| **阶段五：体验优化**        | 提升用户体验和稳定性               | 2/8 完成   | 🟡 进行中   |

---

## 阶段一：MVP 核心功能 ✅

**目标**: 实现基础的命令列表、文件选择、命令执行功能，以及多项目支持和配置系统

### 任务清单

| 任务           | 描述                                                                                                       | 状态 | 完成时间   |
| :------------- | :--------------------------------------------------------------------------------------------------------- | :--- | :--------- |
| 命令扫描和管理 | 自动扫描 `.claude/commands/` 目录，读取命令 frontmatter 元数据，支持命令的图标、描述、分类展示和状态管理 | ✅   | 2026-01-08 |
| 文件选择功能   | 支持 Finder 选中文件获取，文件路径验证和处理，多文件选择支持，文件路径展示优化                             | ✅   | 2026-01-08 |
| 命令执行引擎   | Claude Code CLI 集成，命令参数构建和传递，进程管理和输出捕获，执行结果反馈                                 | ✅   | 2026-01-08 |
| 用户界面       | 命令列表展示，搜索和筛选功能，快捷键支持，加载状态提示                                                     | ✅   | 2026-01-08 |
| 多项目支持     | 支持配置最多 5 个项目目录，命令显示来源项目，自动记录每个命令所属的项目目录，动态查找命令项目目录          | ✅   | 2026-01-11 |
| 配置系统       | Raycast preferences 配置页面，支持自定义项目目录和 Claude CLI 路径，目录验证功能，Worktree 支持            | ✅   | 2026-01-11 |
| 工作目录修复   | 命令在其所属项目目录中执行，确保能正确读取命令依赖（如 @include 文件），扩展接口添加 projectDir 字段       | ✅   | 2026-01-11 |

### 验收标准

- ✅ 能够扫描并展示所有 Claude 命令
- ✅ 支持选择文件并执行命令
- ✅ 命令执行成功并显示结果
- ✅ 用户界面流畅易用
- ✅ 支持多个项目目录配置和切换
- ✅ 命令在正确的项目目录中执行
- ✅ 配置系统易用且提供清晰错误提示

---

## 阶段二：DevonThink 集成 ✅

**目标**: 深度集成 DevonThink，支持直接从 DevonThink 选择文件

### 任务清单

| 任务            | 描述                                                                                    | 状态 | 完成时间   |
| :-------------- | :-------------------------------------------------------------------------------------- | :--- | :--------- |
| DevonThink 检测 | 自动检测 DevonThink 安装，支持 DevonThink 2 和 3，版本兼容性处理                        | ✅   | 2026-01-08 |
| 文件选择集成    | 获取 DevonThink 选中文件，处理 `x-devonthink-item://` URL，文件信息展示（名称、路径） | ✅   | 2026-01-08 |
| 文件导出功能    | 检测文件是否在 `.fseventsd/no_index` 路径，自动导出到临时目录，临时文件清理机制       | ✅   | 2026-01-11 |
| 前端应用检测    | 自动判断前端应用（Finder/DevonThink），智能切换文件获取方式，文件来源标识               | ✅   | 2026-01-08 |

### 验收标准

- ✅ 能够从 DevonThink 获取选中文件
- ✅ 正确处理 DevonThink URL 和路径
- ✅ 自动导出不可访问的文件
- ✅ 支持 DevonThink 2 和 3

---

## 阶段三：日志与监控系统 ✅

**目标**: 完善日志记录、运行状态监控和执行统计功能

### 已完成任务

| 任务           | 描述                                                                                    | 状态 | 完成时间   |
| :------------- | :-------------------------------------------------------------------------------------- | :--- | :--------- |
| 日志时间本地化 | 修复 UTC 时间显示问题，改为本地时间，修复开始/结束时间计算错误，批量修复历史日志文件    | ✅   | 2026-01-11 |
| 执行统计功能   | 创建统计模块，记录执行次数、成功率、执行时间，集成到运行状态界面                        | ✅   | 2026-01-11 |
| 清空历史功能   | 清空所有历史记录（⌘⇧Delete），智能保留正在运行的任务，清理所有日志类型                | ✅   | 2026-01-11 |
| 单个任务操作   | 终止进程（⌘K），强制标记为失败（⌘⇧K），任务列表和日志详情页操作按钮                  | ✅   | 2026-01-11 |
| 日志详情优化   | 使用 Detail.Metadata 组件结构化展示，Emoji 图标直观显示状态，日志统计信息和相对时间显示 | ✅   | 2026-01-11 |
| 历史管理       | 历史记录计数显示，支持单个删除和批量清空，历史记录持久化存储                            | ✅   | 2026-01-11 |
| 日志查看器     | 日志内容实时展示，运行中任务自动刷新（2秒），日志元数据展示（PID、退出码、时长）        | ✅   | 2026-01-11 |
| 日志系统统一   | 统一 JSONL 格式，所有日志事件包含完整 PID 信息                                          | ✅   | 2026-01-11 |
| 运行状态监控   | 多因子进程状态检测，准确判断任务真实状态                                                | ✅   | 2026-01-11 |
| 日志完整性     | completion 事件 100% 记录，任务状态准确显示                                              | ✅   | 2026-01-11 |

### 验收标准

- ✅ 日志实时记录到文件，包含完整 PID 信息
- ✅ 运行状态准确显示（运行中/完成/失败），无僵尸进程误判
- ✅ 日志内容完整可查看，completion 事件正确记录
- ✅ 统计数据准确记录，基于统一的 JSONL 日志系统

---

## 阶段四：关键修复 ✅

**目标**: 修复任务状态读取和监控系统的严重缺陷，确保系统稳定可靠运行

### 已完成任务

| 任务               | 描述                                                                                         | 优先级 | 状态 | 完成时间   |
| :----------------- | :------------------------------------------------------------------------------------------- | :----- | :--- | :--------- |
| 日志系统统一化     | 将分散的 JSONL + Run logs + index files + errors.log 统一为单一 JSONL 格式                   | 🔴 最高 | ✅   | 2026-01-11 |
| PID 信息修复       | 修复 executing 事件中 PID 丢失问题，确保所有日志事件包含完整 PID 信息                        | 🔴 最高 | ✅   | 2026-01-11 |
| 多因子进程检测     | 实现多指标进程状态检测：process.kill(pid, 0) + 日志文件 + 目标文件时间戳 + ps 输出          | 🔴 最高 | ✅   | 2026-01-11 |
| 僵尸进程处理       | 正确识别和清理僵尸进程，避免误判任务状态                                                    | 🔴 最高 | ✅   | 2026-01-11 |
| Completion 事件修复| 修复缺失的 completion 事件，确保任务完成后正确记录结束状态                                  | 🔴 最高 | ✅   | 2026-01-11 |
| 日志读取逻辑更新   | 更新所有日志读取模块（status.tsx, logs.tsx 等），适配统一 JSONL 格式                         | 🟡 高   | ✅   | 2026-01-11 |
| 防御性错误处理     | 为日志写入操作添加 try-catch 保护，防止日志系统故障影响主流程                                | 🟡 高   | ✅   | 2026-01-11 |
| 日志轮转机制       | 实现 JSONL 格式，支持日志轮转和文件大小控制                                                 | 🟢 中   | ✅   | 2026-01-11 |

### 验收标准

- ✅ 所有日志事件包含完整 PID 信息
- ✅ 任务状态准确显示（运行中/完成/失败），无僵尸进程误判
- ✅ JSONL 日志格式统一，数据不分散
- ✅ completion 事件 100% 记录，无遗漏
- ✅ 日志系统具备防御能力，异常情况下不崩溃
- ✅ 日志文件格式可控，支持长期运行

---

## 阶段五：体验优化 🟡

**目标**: 提升用户体验，优化性能和稳定性

### 已完成任务

| 任务               | 描述                                                                                         | 优先级 | 状态 | 完成时间   |
| :----------------- | :------------------------------------------------------------------------------------------- | :----- | :--- | :--------- |
| Session ID 捕获    | 在后台和可视化模式中捕获 Claude Code session ID，支持会话恢复功能                             | 🔴 高  | ✅   | 2026-01-11 |
| 可视化模式实现     | 使用 AppleScript 在 Terminal 窗口中显示命令执行过程，支持调试和实时输出查看                  | 🔴 高  | ✅   | 2026-01-11 |

### 进行中任务

| 任务                 | 描述                                                                                         | 优先级 | 状态      | 预计完成 |
| :------------------- | :------------------------------------------------------------------------------------------- | :----- | :-------- | :------- |
| 环境变量与配置支持   | 支持通过 `--settings` 参数指定配置文件，支持自定义环境变量传递，实现 LLM 端口配置集成       | 🔴 高  | 🟡 规划中 | -        |
| Session ID 日志集成  | 将 session ID 保存到 JSONL 日志，在状态页面显示，支持从历史记录恢复对话                      | 🔴 高  | ⚪ 待开始 | -        |

### 计划任务

| 任务                 | 描述                                                                                         | 优先级 | 状态      | 预计完成 |
| :------------------- | :------------------------------------------------------------------------------------------- | :----- | :-------- | :------- |
| LLM 配置端口集成     | 在 Raycast 配置中添加 LLM 端口设置，通过 settings.json 文件传递给 Claude Code                | 🔴 高  | ⚪ 待开始 | -        |
| 文件选择自动更新     | 当在 Finder 或 DevonThink 中选择新文件后，Raycast 界面自动更新显示新选中的文件，无需手动刷新 | 🔴 高  | ⚪ 待开始 | -        |
| 无头模式性能优化   | 禁用非必要 hooks（SessionStart hook 等），优化环境变量传递，减少启动开销                     | 🔴 高  | ⚪ 待开始 | -        |
| 可见模式性能优化   | 优化终端窗口启动速度，减少 AppleScript 执行延迟，改进进程监控机制                             | 🟡 中  | ⚪ 待开始 | -        |
| 错误处理增强       | 更友好的错误提示，自动重试机制，错误恢复建议，异常情况处理                                   | 🟡 中  | ⚪ 待开始 | -        |
| 命令执行进度条     | 实时显示命令执行进度，提升用户体验                                                           | 🟢 低  | ⚪ 待开始 | -        |
| 详细状态提示       | 提供更详细的状态提示信息，让用户了解当前执行情况                                             | 🟢 低  | ⚪ 待开始 | -        |
| 快捷操作优化       | 优化快捷键和操作流程，提升操作效率                                                           | 🟢 低  | ⚪ 待开始 | -        |
| 界面响应速度提升   | 优化界面渲染逻辑，提升响应速度                                                               | 🟢 低  | ⚪ 待开始 | -        |

### 验收标准

- 命令执行响应时间 < 2秒
- 日志查看加载时间 < 1秒
- 错误提示清晰易懂
- 用户满意度 > 4.5/5

---

## 阶段六：高级配置功能 ⚪

**目标**: 提供灵活的配置选项，支持高级用户自定义 Claude Code 行为

### 计划功能

#### 1. 配置文件支持

**技术方案**:
- 在 Raycast preferences 添加可选的 "Claude Settings 文件路径" 配置项
- 支持 JSON 文件路径或 JSON 字符串两种格式
- 使用 Claude CLI 的 `--settings` 参数传递配置

**配置文件示例** (`claude-settings.json`):
```json
{
  "dangerouslySkipPermissions": true,
  "maxTokens": 8192,
  "model": "claude-sonnet-4-5-20250929",
  "verbose": false
}
```

**实现方式**:
```typescript
// 后台模式
const settingsParam = settingsPath
  ? `--settings "${settingsPath}"`
  : '';
const bashCommand = `cd "${projectDir}" && "${claudeBin}" --print ${settingsParam} --output-format json "${prompt}"`;

// 可视化模式
const scriptContent = `#!/bin/bash
cd "${projectDir}"
"${claudeBin}" --print ${settingsPath ? '--settings "' + settingsPath + '"' : ''} --output-format json "${prompt}"
`;
```

#### 2. LLM 端口配置

**应用场景**:
- 支持本地部署的 LLM 服务（如通过 Ollama、LM Studio 等）
- 支持自定义 API 端点
- 支持企业内网 LLM 服务

**配置方式一: 通过环境变量**
```typescript
const child = spawn('/bin/bash', ['-c', bashCommand], {
  cwd: projectDir,
  env: {
    ...process.env,
    ANTHROPIC_API_URL: customApiUrl,  // 自定义 API 端点
    ANTHROPIC_API_KEY: apiKey,        // API 密钥
  },
});
```

**配置方式二: 通过 settings.json**
```json
{
  "apiUrl": "http://localhost:11434/v1",
  "model": "claude-3-sonnet",
  "headers": {
    "Authorization": "Bearer custom-token"
  }
}
```

#### 3. 自定义环境变量

**Raycast 配置界面**:
- 添加 "自定义环境变量" 文本框（支持多行）
- 格式: `KEY=value`，每行一个
- 示例:
  ```
  ANTHROPIC_API_URL=http://localhost:11434/v1
  ANTHROPIC_API_KEY=sk-custom-key
  DEBUG=true
  ```

**实现代码**:
```typescript
interface Preferences {
  // ... 现有配置
  customEnvVars?: string;  // 自定义环境变量（多行文本）
}

function parseEnvVars(envString?: string): Record<string, string> {
  if (!envString) return {};

  return envString.split('\n')
    .filter(line => line.trim() && !line.startsWith('#'))
    .reduce((acc, line) => {
      const [key, ...valueParts] = line.split('=');
      if (key && valueParts.length > 0) {
        acc[key.trim()] = valueParts.join('=').trim();
      }
      return acc;
    }, {} as Record<string, string>);
}

// 使用
const customEnv = parseEnvVars(prefs.customEnvVars);
const child = spawn('/bin/bash', ['-c', bashCommand], {
  env: { ...process.env, ...customEnv },
});
```

### 任务清单

| 任务                   | 描述                                               | 优先级 | 状态      |
| :--------------------- | :------------------------------------------------- | :----- | :-------- |
| Settings 文件支持      | 支持通过 `--settings` 参数传递配置文件              | 🔴 高  | ⚪ 待开始 |
| 自定义环境变量         | 在 Raycast 配置中支持自定义环境变量                 | 🔴 高  | ⚪ 待开始 |
| LLM 端口配置           | 支持配置本地 LLM 服务端点                           | 🔴 高  | ⚪ 待开始 |
| 配置文件模板           | 提供常见配置场景的模板文件                          | 🟡 中  | ⚪ 待开始 |
| 配置验证               | 验证配置文件格式和参数有效性                        | 🟡 中  | ⚪ 待开始 |

### 验收标准

- ✅ 支持通过配置文件自定义 Claude Code 行为
- ✅ 支持配置本地 LLM 服务端点
- ✅ 支持自定义环境变量传递
- ✅ 配置错误时提供清晰的错误提示
- ✅ 兼容所有现有功能（后台模式、可视化模式）

---

## 技术债务

### 需要重构和修复的部分

| 任务            | 描述                                                                     | 优先级 | 状态        |
| :-------------- | :----------------------------------------------------------------------- | :----- | :---------- |
| Worktree 兼容性 | 通过配置页面设置项目目录，支持 worktree 开发；日志目录仍需优化为相对路径 | 🟡 中  | 🟡 部分完成 |
| 代码结构优化    | 组件拆分细化，工具函数模块化，类型定义完善，测试覆盖提升                 | 🟡 中  | ⚪ 待开始   |
| 日志系统改进    | 日志轮转机制，日志压缩存储，日志清理策略，日志性能优化                   | 🟡 中  | ⚪ 待开始   |
| 状态管理        | 引入状态管理库（如 Zustand），统一状态更新机制，缓存策略优化，状态持久化 | 🟡 中  | ⚪ 待开始   |
| 错误处理完善    | 网络错误处理，文件权限错误提示，超时处理优化，异常恢复机制               | 🟡 中  | ⚪ 待开始   |

---

## 进度日志

### 2026-01-11

- **重大重构**: 扩展重命名为 "Agent Executor"，成为通用工具
  - 从 AutoWeave 专用工具转变为适用于任何 Claude Code 项目的通用执行器
  - 所有接口和变量名从 `AutoWeave*` 重命名为 `Agent*` 或 `project*`
  - 移除硬编码的默认项目目录，要求用户在首次使用时配置
- **多项目支持**: 完成多项目目录功能
  - 支持配置最多 5 个项目目录，统一展示所有项目的命令
  - 每个命令显示其来源项目，方便区分和管理
  - 自动提取项目名称（从目录路径）
  - 验证所有配置的目录是否有效
- **配置系统**: 添加 Raycast preferences 配置页面
  - 支持用户自定义项目目录（解决硬编码路径问题）
  - 支持自定义 Claude CLI 可执行文件路径
  - 添加目录验证功能，确保配置的目录包含 `.claude/commands/`
  - 为扩展分发做好准备
- **工作目录修复**: 修复命令执行时的工作目录问题
  - 命令现在在其所属的项目目录中执行，确保能正确读取命令依赖（如 `@include` 文件）
  - 修复前所有命令都在第一个配置的项目目录中执行，导致某些命令无法找到其依赖文件
  - 扩展 `CommandMetadata` 接口，添加 `projectDir` 字段记录命令所属项目目录
  - 创建 `findCommandProjectDir()` 辅助函数，动态查找命令所属的项目目录
- **动态命令系统**: 删除硬编码的单个命令文件
  - 删除 `preprocess.tsx`, `proposal.tsx`, `search.tsx`, `router.tsx` 四个硬编码命令文件
  - 所有命令现在完全通过 `commands.tsx` 动态读取和执行
  - 统一了命令执行方式，提升了系统的一致性和可维护性
- **Worktree 支持**: 通过配置页面支持 Git Worktree 开发工作流
- **命令界面优化**: 去除命令描述中的冗余信息
  - 去除命令描述中的项目名称括号
  - 因为右侧 accessories 已经显示项目来源，描述中的括号内容显得冗余
  - 界面更简洁，信息展示更清晰
- **图标多样性优化**: 完成命令图标多样性改进
  - 扩展图标库从 10 个到 70+ 个不同的图标
  - 实现双层匹配机制：关键词语义匹配 + 哈希随机绑定
  - 添加 50+ 个关键词映射规则，覆盖常见命令类型
  - 显著降低命令列表中图标的重复率，提升视觉识别度
- **🔴 关键问题识别**: 发现任务状态读取和监控系统的严重缺陷
  - PID 信息在 executing 事件中丢失
  - 数据分散在 JSONL + Run logs + index files + errors.log 多个文件中
  - 缺少 completion 事件，导致任务无法正确标记为完成
  - 僵尸进程检测失效，误判任务状态
  - 日志系统缺乏防御性错误处理
- **📋 修复方案制定**: 完成详细的日志系统重构计划
  - 创建统一的 JSONL 格式规范
  - 设计多因子进程检测机制
  - 制定分阶段实施策略（4个子阶段）
  - 识别所有需要更新的代码位置
- **✅ 阶段三、四完成**: 日志系统和关键缺陷修复全部完成
  - 实现统一的 JSONL 格式，所有日志事件包含完整 PID 信息
  - 实现多因子进程检测机制（process.kill + 日志文件 + 文件时间戳 + ps输出）
  - 修复 completion 事件缺失问题，任务状态准确显示
  - 添加防御性错误处理，系统稳定可靠
  - 支持日志轮转，长期运行稳定
- **✅ 可视化模式实现**: 完成 Terminal 窗口显示功能
  - 使用 AppleScript 在新的 Terminal 窗口中执行 Claude Code 命令
  - 支持实时查看命令执行过程和完整输出
  - 在配置中添加"后台运行模式"开关，支持调试场景
  - 窗口保持打开，方便用户查看完整日志
- **✅ Session ID 捕获**: 实现会话 ID 提取和显示
  - 后台模式：使用 `--output-format json` 捕获 session_id，保存在执行结果中
  - 可视化模式：在 Terminal 窗口中显示 session_id 和恢复命令提示
  - 更新 `ClaudeExecutionResult` 接口，添加 `sessionId` 字段
  - 为后续会话恢复功能奠定基础
- **📋 环境变量与配置规划**: 规划 Claude Code 配置文件支持
  - 发现 Claude CLI 支持 `--settings` 参数指定配置文件
  - 支持通过环境变量传递自定义配置
  - 规划在 Raycast 配置中添加配置文件路径选项
  - 计划实现自定义环境变量传递功能

### 2026-01-08

- **重大进展**: 完成 DevonThink 3 集成修复
- **功能新增**: 添加附加留言功能
- **文档完善**: 记录所有已实现功能

---

## 里程碑规划

| 版本   | 预计时间   | 主要目标                                                     | 状态        |
| :----- | :--------- | :----------------------------------------------------------- | :---------- |
| v0.1.0 | 2026-01-10 | MVP 核心功能完成                                             | ✅ 已发布   |
| v0.1.1 | 2026-01-11 | DevonThink 3 集成修复                                        | ✅ 已发布   |
| v0.1.2 | 2026-01-11 | 日志和统计功能完善                                            | ✅ 已发布   |
| v0.2.0 | 2026-01-11 | 多项目支持、配置系统、工作目录修复、通用化重命名               | ✅ 已发布   |
| v0.3.0 | 2026-01-11 | 任务状态读取和监控系统关键缺陷修复                            | ✅ 已完成   |
| v0.4.0 | 待定       | 阶段五体验优化任务                                            | ⚪ 未开始   |

---
